# Kakeru v2.6.0 アップデートのお知らせ

いつもKakeruをご利用いただきありがとうございます。
2025年8月27日にリリースした最新版の内容をお知らせいたします。

## 📢 今回のアップデートについて
今回のアップデートで、AIによるSOAP改善提案機能が本格導入され、SOAP編集機能が大幅に強化されました。複数のSOAPを一括で更新したり、薬品名を一度に置換したりすることで、作業効率が飛躍的に向上します。

## 🆕 新しく追加された機能

### 🤖 AI駆動のSOAP改善提案システム
AIがSOAPの内容をリアルタイムで分析し、改善提案を自動生成する機能を追加しました。診療記録の質が大幅に向上します。

**お手元での確認方法：**
1. 診療記録作成画面でSOAPを入力します
2. 画面右下に新しく追加されたフローティングチャットアイコンをクリックします
3. AIからの改善提案がリアルタイムで表示されます
4. 「適用」ボタンをクリックすると提案が即座にSOAPに反映されます
5. 「却下」ボタンで提案を消去できます

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 実装PR: yakureki-back#463, yakureki-front#326
- 主な変更:
  - AIによるSOAP改善提案エンジンの実装
  - 基本項目・加算項目・フォローアップの3カテゴリ別提案
  - フローティングチャットウィジェット UI
  - リアルタイム処理のためのWebSocket導入
- パフォーマンス: 提案生成時間 5秒→0.5秒（N+1問題解消）

</details>

### ✏️ SOAP一括更新機能
複数のSOAPを選択して一度に更新できる機能を追加しました。定期的な更新作業が大幅に効率化されます。

**お手元での確認方法：**
1. SOAP一覧画面で複数のSOAPをチェックボックスで選択します
2. 画面上部に「一括更新」ボタンが新しく表示されます
3. 「一括更新」ボタンをクリックして、複数のSOAPを同時に更新できます

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 実装PR: yakureki-back#460, #465
- 機能内容:
  - SOAP一括更新・バルク処理
  - テキスト置換機能の統合
  - LLMを使用した一括改善

</details>

### 💊 医薬品一括置換システム
SOAP内の薬剤名を一括で置換できる機能を追加しました。ジェネリック医薬品への切り替えなどが簡単に行えます。

**お手元での確認方法：**
1. 「患者メニュー」ボタンをクリックします
2. SOAP編集画面で薬剤名（例：「〇〇錠」）をクリックします
2. 薬剤選択モーダルが自動的に開きます
3. 複数の薬剤をチェックボックスで選択します
4. 「一括置換」ボタンをクリックすると、SOAP内の全箇所が一度に置換されます

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 実装PR: yakureki-front#322, #323, #331
- 機能内容:
  - スマート薬剤置換
  - 複数薬剤の同時選択
  - 全セクション対応
  - チェックボックス選択状態の維持

</details>

### ➕ SOAP編集モードの項目追加機能
SOAP編集時に新しい項目を簡単に追加できる機能を実装しました。

**お手元での確認方法：**
1. 「患者メニュー」ボタンをクリックします
2. 患者様を選択します
2. 各セクション（S/O/A/P）の下部に「＋新しい項目を追加」ボタンが表示されます
3. 「＋新しい項目を追加」ボタンをクリックすると、即座に新規項目が追加されます
4. 追加された項目に直接入力できます

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 実装PR: yakureki-front#327, #329
- UI改善:
  - 統一されたボタンデザイン
  - 直感的な操作性
  - 編集モードでのみ表示

</details>

### 🔄 文字列自動置換エンジン
管理者が設定したルールに基づいて、SOAP内の文字列を自動置換する機能を追加しました。

**お手元での確認方法（管理者向け）：**
1. 「管理ポータルへ」ボタンをクリックします
2. 「文字列置換設定」カードをクリックします
2. 新規ルールを作成（例：「BP」→「血圧」）します
3. SOAPで「BP」と入力すると自動で「血圧」に変換されます

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 実装PR: yakureki-back#451, #323
- カスタムルール置換システム:
  - MedicineNameReplacementRule
  - 常時発火対応
  - ルール管理構造の再編成（#466）

</details>

## 📈 使いやすさの改善

### 文字起こしエラーの改善
- **改善前：** エラー発生時に再試行が困難
- **改善後：** 「再生成」ボタンとヒント表示で簡単に再試行可能

**お手元での確認方法：**
1. 「患者メニュー」ボタンをクリックします
2. 音声録音→文字起こし機能を使用します
3. エラー発生時に「再生成」ボタンが表示されます
3. エラーの原因と対処法のヒントが分かりやすく表示されます

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 実装PR: yakureki-front#314
- 改善内容:
  - 再生成ボタンの追加
  - エラーヒントの表示
  - UXの向上

</details>

### 空状態表示のコンパクト化
- **改善前：** データがない画面で大きな空白表示
- **改善後：** コンパクトで見やすい表示に改善

**お手元での確認方法：**
1. 「患者メニュー」ボタンをクリックします
2. データがない画面（新規患者など）を表示します
2. 従来より30%コンパクトな表示になっています
3. 必要な操作ボタンが目立つ位置に配置されています

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 実装PR: yakureki-front#334
- 改善内容:
  - 空状態UIのコンパクト化
  - SOAP改善提案Toast表示時間延長（5秒）

</details>

## ✅ 不具合の修正

### SOAP更新が本番環境で反映されない問題を修正
- **修正内容：** 本番環境でSOAP更新が正しく反映されない問題を修正
- **影響範囲：** SOAP編集・更新機能全般

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 修正PR: yakureki-front#316
- 原因: キャッシュ管理の不備
- 対策: 更新後の適切なキャッシュクリア処理

</details>

### 管理画面のエラー修正
- **修正内容：** RequestEvent管理画面やSoapChatConversationページでの500エラーを修正
- **影響範囲：** 管理者向け管理画面

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 修正PR: yakureki-back#428, #472
- 原因: URLパスの不整合
- 対策: 管理画面の表示改善（#425, #430, #433）

</details>

### 薬歴表示日数の不具合修正
- **修正内容：** 設定した表示日数通りに薬歴が表示されない問題を修正
- **影響範囲：** 薬歴表示機能

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 修正PR: yakureki-back#444, yakureki-front#307
- 原因: display_days計算の不具合
- 対策: 完全な日数範囲を表示するよう改善

</details>

### RMPデータ判定の改善
- **修正内容：** リスク管理計画（RMP）対象薬剤の判定精度を向上
- **影響範囲：** RMP薬剤の患者向け資材表示

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 修正PR: yakureki-back#439
- 改善内容: 製品ごとの正確な判定実装

</details>

## ⚡ パフォーマンス改善

### AI処理の大幅な高速化と安定化
- SOAP改善提案の生成速度が10倍に向上
- エラー発生率が90%減少
- 429エラー（レート制限）への自動対応

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- **エラー対策**（yakureki-back#411, #415, #420）
  - Exponential Backoff with Jitter実装
  - 429エラーの自動リトライ
  - リトライ処理のリファクタリング（#424）
- **タイムアウト改善**（yakureki-back#419）
  - Gemini APIタイムアウト45秒に延長
- **温度パラメータ管理**（yakureki-back#408, #436）
  - リトライ時の温度調整
  - SOAP生成の温度管理リファクタリング

</details>

### データベースの最新化
- PostgreSQL 17への移行により処理速度が向上
- 大量データの安定処理が可能に

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 実装PR: yakureki-back#475
- 改善内容:
  - PostgreSQL 15 → 17
  - クエリ最適化
  - インデックス改善

</details>

### ビルド・デプロイの高速化
- パッケージマネージャーをuvに移行
- デプロイ時間が従来の半分に短縮

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

- 実装PR: yakureki-back#442
- 改善内容:
  - uvパッケージマネージャー採用
  - Dockerイメージ最適化
  - 依存関係の整理

</details>

## 🏗️ システム基盤の更新

<details>
<summary>🔧 技術詳細（クリックで展開）</summary>

このセクションは技術者向けの情報です。

### コード構造の大規模リファクタリング
- yakurekiモデルのリファクタリング完了（#450）
- yakurekiアプリのサービス構成整理（#448）
- deprecatedモデルの削除（#445）
- yakureki_formatterアプリへのモデル移行（#449）

### セキュリティ強化
- 本番環境でAPIドキュメント無効化（#437）
- 各種設定の整理（#474）
- Python 3.9型注釈エラー修正（#453）

### 開発効率向上
- RequestEvent処理時間分析機能追加（#418）
- RequestEventラベルに受付番号表示（#443）
- copy_formatter_dataコマンドのパフォーマンス改善（#455）
- ドキュメントフォルダ構造の再編成（yakureki-front#319）

### 新機能の基盤整備
- 乳幼児服薬指導加算チェックポイント実装（#378）
- ハイリスク薬剤判定アルゴリズムのリファクタリング（#380）
- トレーシングレポート推奨判定機能統合（#399）
- 調剤年月日に基づくNSIPS作成日時の自動設定（#381）

</details>

## 🔄 アップデート方法

システムは自動的に更新されます。特別な操作は必要ありません。

## ⚠️ ご注意事項

- AI改善提案機能は段階的にリリースされる場合があります
- 文字列置換ルールの設定は管理者権限が必要です
- 一括更新機能は大量のデータ処理を行うため、混雑時を避けてご利用ください

## 💡 便利な使い方のヒント

- SOAP改善提案は、提案内容を確認してから適用することをおすすめします
- 薬品の一括置換機能は、ジェネリック医薬品への切り替え時に特に便利です
- 文字列置換ルールで、よく使う略語を登録すると入力効率が向上します
- SOAP編集時は「＋新しい項目を追加」ボタンで簡単に項目を増やせます

## 📞 お問い合わせ

ご不明な点やお困りの際は、以下までお気軽にお問い合わせください：

- **電話：** [サポート電話番号]
- **メール：** support@medilab.jp
- **営業時間：** 平日 9:00-18:00

---

今後ともKakeruをよろしくお願いいたします。